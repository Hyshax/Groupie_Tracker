<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Groupie Tracker</title>
    <link rel="stylesheet" href="/static/style.css">
</head>
<body>
    <h1>Groupie Tracker</h1>
    
    <div class="grid">
        {{range .}}
        <div class="card" 
             onclick="openModal(this)"
             data-id="{{.ID}}"
             data-name="{{.Name}}"
             data-image="{{.Image}}"
             data-creation="{{.CreationDate}}"
             data-album="{{.FirstAlbum}}">
            
            <img src="{{.Image}}" alt="{{.Name}}">
            <p>{{.Name}}</p>
            
            <div class="hidden-members" id="members-{{.ID}}" style="display:none;">{{range .Members}}{{.}}|{{end}}</div>
        </div>
        {{end}}
    </div>

    <div id="artistModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal()">&times;</span>
            
            <div class="modal-header">
                <img id="modal-img" src="" alt="">
                <div class="modal-info">
                    <h2 id="modal-name">Nom de l'artiste</h2>
                    <p><strong>Création :</strong> <span id="modal-creation"></span></p>
                    <p><strong>Premier Album :</strong> <span id="modal-album"></span></p>
                    
                    <div class="members-section">
                        <h3>Membres</h3>
                        <div id="modal-members" class="tags-container"></div>
                    </div>
                </div>
            </div>

            <div class="concerts-container">
                <div class="column locations">
                    <h3>Villes de Passage</h3>
                    <ul id="locations-list">Chargement...</ul>
                </div>
    
                <div class="column past">
                    <h3>Concerts Passés</h3>
                    <ul id="past-concerts-list">Chargement...</ul>
                </div>
            </div>
        </div>
    </div>

    <script>
        async function openModal(element) {
            const id = element.dataset.id;
            const name = element.dataset.name;
            const image = element.dataset.image;
            const creation = element.dataset.creation;
            const firstAlbum = element.dataset.album;

            const modal = document.getElementById("artistModal");
            document.getElementById("modal-name").innerText = name;
            document.getElementById("modal-img").src = image;
            document.getElementById("modal-creation").innerText = creation;
            document.getElementById("modal-album").innerText = firstAlbum;
            
            const membersDiv = document.getElementById("members-" + id);
            const rawMembers = membersDiv.textContent || membersDiv.innerText;
            const membersList = rawMembers.split('|').filter(m => m.trim() !== "");
            
            const membersContainer = document.getElementById("modal-members");
            membersContainer.innerHTML = "";
            
            membersList.forEach(member => {
                let cleanMember = member.trim(); 
                if (cleanMember !== "") {
                    let span = document.createElement("span");
                    span.className = "tag";
                    span.innerText = cleanMember;
                    membersContainer.appendChild(span);
                }
            });

            modal.style.display = "block";
            document.body.style.overflow = "hidden";
            
            loadRelations(id);
        }

        function closeModal() {
            document.getElementById("artistModal").style.display = "none";
            document.body.style.overflow = "auto";
        }

        window.onclick = function(event) {
            const modal = document.getElementById("artistModal");
            if (event.target == modal) {
                closeModal();
            }
        }

        async function loadRelations(id) {
            const locationsList = document.getElementById("locations-list"); 
            const pastList = document.getElementById("past-concerts-list");
            
            locationsList.innerHTML = '<li class="loading">Chargement...</li>';
            pastList.innerHTML = '<li class="loading">Chargement...</li>';

            try {
                const response = await fetch(`/api/relations/${id}`);
                
                if (!response.ok) throw new Error("Erreur réseau");
                const data = await response.json();
                
                let pastConcerts = [];
                let allLocations = []; 
                const today = new Date();   

                for (const [location, dates] of Object.entries(data.datesLocations)) {
                    const cleanLoc = location.replace(/_/g, " ").replace(/-/g, ", ").replace(/\b\w/g, l => l.toUpperCase());
                    
                    allLocations.push(cleanLoc);

                    dates.forEach(dateStr => {
                        const parts = dateStr.split('-');
                        const concertDate = new Date(`${parts[2]}-${parts[1]}-${parts[0]}`); 
                        const concertObj = { date: dateStr, loc: cleanLoc, dateObj: concertDate };

                        if (concertDate < today) {
                            pastConcerts.push(concertObj);
                        }
                    });
                }
                
                pastConcerts.sort((a, b) => b.dateObj - a.dateObj);
                allLocations.sort();

                renderSimpleList(locationsList, allLocations); 
                renderConcertList(pastList, pastConcerts);    

            } catch (error) {
                console.error(error);
                locationsList.innerHTML = "<li>Info non disponible</li>";
                pastList.innerHTML = "<li>Info non disponible</li>";
            }
        }

        function renderSimpleList(element, data) {
            element.innerHTML = "";
            if (data.length === 0) {
                element.innerHTML = "<li>Aucune donnée.</li>";
                return;
            }
            const uniqueData = [...new Set(data)];
            
            uniqueData.forEach(item => {
                let li = document.createElement("li");
                li.innerHTML = `<span class="c-loc" style="text-align:left;">${item}</span>`;
                element.appendChild(li);
            });
        }

        function renderConcertList(element, data) {
            element.innerHTML = "";
            if (data.length === 0) {
                element.innerHTML = "<li>Aucun concert passé.</li>";
                return;
            }
            data.forEach(c => {
                let li = document.createElement("li");
                li.innerHTML = `<span class="c-date">${c.date}</span> <span class="c-loc">${c.loc}</span>`;
                element.appendChild(li);
            });
        }
    </script>
</body>
</html> 